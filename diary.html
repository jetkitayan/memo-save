<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diary â€” NOTEã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆæ—¥è¨˜ä½œæˆãƒ»ä¸€è¦§ãƒ»ç·¨é›†ãƒ»æ¤œç´¢ï¼‰</title>
  <style>
    :root{
      --bg:#0b0c0f; --panel:#14161c; --muted:#a0a6b5; --border:#262b3a; --accent:#4da3ff; --ok:#2ecc71; --warn:#ffb020; --danger:#ff4d4f;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#0b0c0f;color:#e8ecf1}
    .wrap{max-width:1200px;margin:20px auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:linear-gradient(180deg,#171a22 0%,#111319 100%);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .grid{display:grid;grid-template-columns: 1.05fr 1fr; gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    label{font-size:12px;color:var(--muted)}
    input[type="text"], input[type="date"], textarea, select{
      width:100%; background:#0e1016;border:1px solid var(--border); color:#e8ecf1;
      border-radius:12px; padding:10px 12px; font-size:15px; outline:none;
    }
    input:focus, textarea:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(77,163,255,.15)}
    textarea{min-height:220px; resize:vertical}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .row4{display:grid; grid-template-columns: repeat(4,1fr); gap:10px}
    @media (max-width: 720px){ .row, .row3, .row4{grid-template-columns:1fr} }

    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;letter-spacing:.3px;cursor:pointer;color:#0b0c0f}
    .b-primary{background:var(--accent)}
    .b-secondary{background:#374155;color:#e8ecf1}
    .b-ghost{background:transparent;border:1px solid var(--border);color:#e8ecf1}
    .b-ok{background:var(--ok)} .b-warn{background:var(--warn)} .b-danger{background:var(--danger)}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap}

    table{width:100%; border-collapse:collapse}
    th, td{border-bottom:1px solid var(--border); padding:10px; text-align:left; vertical-align:top;}
    th{color:var(--muted); font-weight:600}
    tr.hidden{opacity:.5}
    .pill{display:inline-block; padding:3px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:#dfe6f7}

    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .right{justify-content:flex-end}
    .grow{flex:1}
    .nowrap{white-space:nowrap}
    .ellipsis{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}

    footer{margin-top:12px;color:var(--muted);font-size:12px}

    .badge{display:inline-grid;place-items:center; width:22px;height:22px;border-radius:999px;border:1px solid var(--border)}
  </style>
</head>
<body>
  <!--
    Diary â€” NOTEã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆæ—¥è¨˜ï¼‰
    â–  ç›®çš„: æ—¢å­˜ã®ã€Œæ–‡ç« ä¿å­˜ãƒŸãƒ‹ã‚¢ãƒ—ãƒªï¼ˆNOTEï¼‰ã€ã¨åŒã˜ä»•çµ„ã¿ï¼ˆJSONã«è¿½è¨˜ãƒ»ç·¨é›†ãƒ»éè¡¨ç¤ºï¼‰ã§æ—¥è¨˜ã‚’ä½œæˆ/é–²è¦§/ç·¨é›†
    â–  API ã«ã¤ã„ã¦
      - æ—¢å­˜ã® fetch(`${API_BASE}${path}`, { ...options, headers }) æ–¹å¼ã‚’è¸è¥²
      - ä¸‹ã® PATHS ã‚’ã€ã‚ãªãŸã®æ—¢å­˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„
        ä¾‹) Vercel/Cloudflare/Firebase Functions ç­‰

      PATHS = {
        list:    '/diary/list',              // GET  ?q&from&to&offset&limit&includeHidden
        create:  '/diary/create',            // POST {entry}
        update:  (id)=>`/diary/update/${id}`,// PUT  {entry}
        toggle:  (id)=>`/diary/toggle/${id}`,// PATCH {hidden:bool}
        random:  '/diary/random'             // GET  1ä»¶è¿”ã™
      }

    â–  ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆæ¨å¥¨ï¼‰
      id: string  // æ—¢å­˜NOTEã¨åŒæ§˜ï¼ˆã‚µãƒ¼ãƒå´æ¡ç•ªã§ã‚‚OKï¼‰
      date: 'YYYY-MM-DD'
      title: string
      body: string (é•·æ–‡)
      tags: string[]
      mood: 'good' | 'okay' | 'bad'
      favorite: boolean
      hidden: boolean
      createdAt: ISO-string
      updatedAt: ISO-string

    â–  èªè¨¼
      AUTH_TOKEN ã‚’å¿…è¦ã«å¿œã˜ã¦ãƒ˜ãƒƒãƒ€ã«ä»˜ä¸ï¼ˆBasic/Bearerç­‰ã€æ—¢å­˜NOTEã®ä»•æ§˜ã«åˆã‚ã›ã‚‹ï¼‰
  -->

  <div class="wrap">
    <header>
      <h1>Diary <span class="muted">â€” NOTEã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆæ—¥è¨˜ãƒ»é•·æ–‡ä¿å­˜ï¼‰</span></h1>
      <div class="toolbar right">
        <button id="exportBtn" class="btn b-ghost">â¬‡ Export JSON</button>
        <label class="btn b-ghost" for="importFile">â¬† Import JSON</label>
        <input id="importFile" type="file" accept="application/json" hidden />
      </div>
    </header>

    <div class="grid">
      <!-- ä½œæˆ / ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
      <section class="card" id="editor">
        <div class="row">
          <div>
            <label>æ—¥ä»˜</label>
            <input id="f-date" type="date" />
          </div>
          <div>
            <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
            <input id="f-title" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰" />
          </div>
        </div>
        <div style="margin-top:10px">
          <label>æœ¬æ–‡</label>
          <textarea id="f-body" placeholder="ä»Šæ—¥ã®å‡ºæ¥äº‹ãƒ»æ°—ã¥ããƒ»å­¦ã³...ï¼ˆé•·æ–‡OKï¼‰"></textarea>
        </div>
        <div class="row3" style="margin-top:10px">
          <div>
            <label>ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input id="f-tags" type="text" placeholder="work, fitness, family" />
          </div>
          <div>
            <label>æ°—åˆ†</label>
            <select id="f-mood">
              <option value="okay">ğŸ˜ æ™®é€š</option>
              <option value="good">ğŸ˜€ è‰¯ã„</option>
              <option value="bad">ğŸ˜ ã„ã¾ã„ã¡</option>
            </select>
          </div>
          <div>
            <label>ãƒ•ãƒ©ã‚°</label>
            <div class="flex">
              <button id="f-fav" class="btn b-ghost" type="button">â˜† Favorite</button>
              <button id="f-hide" class="btn b-ghost" type="button">ğŸ‘ éè¡¨ç¤º</button>
            </div>
          </div>
        </div>

        <div class="flex" style="margin-top:12px">
          <div class="grow toolbar">
            <button id="saveBtn" class="btn b-primary">ğŸ’¾ æ–°è¦ä¿å­˜</button>
            <button id="updateBtn" class="btn b-ok" disabled>âŸ³ ä¸Šæ›¸ãä¿å­˜</button>
            <button id="resetBtn" class="btn b-secondary">â†º å…¥åŠ›ã‚¯ãƒªã‚¢</button>
          </div>
          <div class="toolbar">
            <button id="randomBtn" class="btn b-warn">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º</button>
          </div>
        </div>
        <div id="status" class="muted mono" style="margin-top:8px"></div>
      </section>

      <!-- æ¤œç´¢ / ä¸€è¦§ -->
      <section class="card" id="list">
        <div class="row4">
          <div>
            <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
            <input id="q" type="text" placeholder="æœ¬æ–‡ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚¿ã‚°æ¤œç´¢" />
          </div>
          <div>
            <label>æœŸé–“ï¼ˆFROMï¼‰</label>
            <input id="from" type="date" />
          </div>
          <div>
            <label>æœŸé–“ï¼ˆTOï¼‰</label>
            <input id="to" type="date" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="toolbar">
              <button id="searchBtn" class="btn b-secondary">ğŸ” æ¤œç´¢</button>
              <button id="showAllBtn" class="btn b-ghost">â¤´ ã™ã¹ã¦</button>
            </div>
          </div>
        </div>
        <div class="flex" style="margin-top:10px">
          <div class="toolbar">
            <button id="toggleHiddenBtn" class="btn b-ghost">ğŸ‘â€ğŸ—¨ éè¡¨ç¤ºã‚‚å«ã‚ã‚‹: <span id="hiddenState">NO</span></button>
          </div>
          <div class="grow"></div>
          <div class="toolbar">
            <span class="muted">ä»¶æ•°: <span id="count">0</span></span>
          </div>
        </div>

        <div style="margin-top:10px; max-height:60vh; overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th class="nowrap">æ—¥ä»˜</th>
                <th>ã‚¿ã‚¤ãƒˆãƒ« / æœ¬æ–‡ï¼ˆå†’é ­ï¼‰</th>
                <th class="nowrap">ã‚¿ã‚°</th>
                <th class="nowrap">æ°—åˆ†</th>
                <th class="nowrap">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <footer>
      ä¿å­˜ã¯ã‚µãƒ¼ãƒãƒ¼ï¼ˆJSONï¼‰ã«è¡Œã„ã¾ã™ã€‚å¤±æ•—æ™‚ã¯ãƒ–ãƒ©ã‚¦ã‚¶å´ã«ä¸€æ™‚ä¿å­˜ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ã—ã¾ã™ã€‚
    </footer>
  </div>

  <script>
    // ====== è¨­å®š ======
    const API_BASE = localStorage.getItem('DIARY_API_BASE') || 'https://example.com/api'; // â† æ—¢å­˜NOTEã® BASE ã«å¤‰æ›´
    const AUTH_TOKEN = localStorage.getItem('DIARY_AUTH_TOKEN') || '';                  // â† èªè¨¼ãŒå¿…è¦ãªã‚‰è¨­å®š

    // æ—¢å­˜NOTEã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«åˆã‚ã›ã¦ã“ã“ã‚’ç·¨é›†
    const PATHS = {
      list: '/diary/list',                       // GET
      create: '/diary/create',                   // POST
      update: (id)=>`/diary/update/${id}`,       // PUT
      toggle: (id)=>`/diary/toggle/${id}`,       // PATCH
      random: '/diary/random'                    // GET
    };

    // ====== å…±é€šãƒ˜ãƒ«ãƒ‘ ======
    const $ = (s)=>document.querySelector(s);
    const statusEl = $('#status');

    function headers(){
      const h = {'Content-Type':'application/json'};
      if(AUTH_TOKEN) h['Authorization'] = AUTH_TOKEN.startsWith('Bearer ')? AUTH_TOKEN : `Bearer ${AUTH_TOKEN}`;
      return h;
    }

    async function api(path, opt={}){
      const url = `${API_BASE}${path}`;
      const res = await fetch(url, {...opt, headers:{...headers(), ...(opt.headers||{})}});
      if(!res.ok){ throw new Error(`${res.status} ${res.statusText}`); }
      const ct = res.headers.get('content-type')||'';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    function toast(msg, ok=true){ statusEl.textContent = `${new Date().toLocaleTimeString()}  ${ok?'âœ“':'âœ—'} ${msg}`; statusEl.style.color = ok? '#86efac':'#ff9aa2'; }

    // ====== ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ ======
    let currentId = null; // null=æ–°è¦ã€æ–‡å­—åˆ—=ç·¨é›†
    let showHidden = false;

    function today(){ const d=new Date(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${dd}`; }

    function getForm(){
      return {
        date: $('#f-date').value || today(),
        title: $('#f-title').value.trim(),
        body: $('#f-body').value,
        tags: $('#f-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
        mood: $('#f-mood').value,
        favorite: $('#f-fav').classList.contains('active'),
        hidden: $('#f-hide').classList.contains('active'),
      };
    }

    function setForm(e){
      $('#f-date').value = e.date || today();
      $('#f-title').value = e.title||'';
      $('#f-body').value = e.body||'';
      $('#f-tags').value = (e.tags||[]).join(', ');
      $('#f-mood').value = e.mood||'okay';
      setToggle('#f-fav', !!e.favorite);
      setToggle('#f-hide', !!e.hidden);
    }

    function setToggle(sel, on){ const el=$(sel); el.classList.toggle('active', !!on); el.style.borderColor = on? '#ffd166':'#262b3a'; }

    function clearForm(){ currentId=null; setForm({date:today(), title:'', body:'', tags:[], mood:'okay', favorite:false, hidden:false}); $('#updateBtn').disabled=true; $('#saveBtn').disabled=false; toast('å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ'); }

    // ====== ã‚¤ãƒ™ãƒ³ãƒˆ ======
    $('#f-fav').addEventListener('click', ()=> setToggle('#f-fav', !$('#f-fav').classList.contains('active')) );
    $('#f-hide').addEventListener('click', ()=> setToggle('#f-hide', !$('#f-hide').classList.contains('active')) );

    $('#resetBtn').addEventListener('click', clearForm);

    $('#saveBtn').addEventListener('click', async()=>{
      try{
        const entry = getForm();
        const body = JSON.stringify({entry});
        const data = await api(PATHS.create, {method:'POST', body});
        currentId = data.id || data.entry?.id || null; // ã‚µãƒ¼ãƒå¿œç­”ã«åˆã‚ã›ã¦èª¿æ•´
        $('#updateBtn').disabled = !currentId;
        toast('æ–°è¦ä¿å­˜ã—ã¾ã—ãŸ');
        await refresh();
      }catch(e){
        console.error(e); toast('ä¿å­˜ã«å¤±æ•—ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã«å¾…é¿ã—ã¾ã™', false); backupLocal('create', getForm());
      }
    });

    $('#updateBtn').addEventListener('click', async()=>{
      if(!currentId){ toast('ç·¨é›†å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“', false); return; }
      try{
        const entry = {...getForm(), id: currentId};
        const body = JSON.stringify({entry});
        await api(PATHS.update(currentId), {method:'PUT', body});
        toast('ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸ');
        await refresh();
      }catch(e){ console.error(e); toast('æ›´æ–°ã«å¤±æ•—ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã«å¾…é¿ã—ã¾ã™', false); backupLocal('update', {...getForm(), id: currentId}); }
    });

    $('#randomBtn').addEventListener('click', async()=>{
      try{
        const data = await api(PATHS.random);
        const e = data.entry || data; // ã‚µãƒ¼ãƒã®è¿”å½¢ã«åˆã‚ã›ã‚‹
        currentId = e.id||null; setForm(e); $('#updateBtn').disabled = !currentId; $('#saveBtn').disabled=!!currentId;
        toast('ãƒ©ãƒ³ãƒ€ãƒ ã«å–å¾—ã—ã¾ã—ãŸ');
      }catch(e){ console.error(e); toast('ãƒ©ãƒ³ãƒ€ãƒ å–å¾—ã«å¤±æ•—', false); }
    });

    $('#searchBtn').addEventListener('click', refresh);
    $('#showAllBtn').addEventListener('click', ()=>{ $('#q').value=''; $('#from').value=''; $('#to').value=''; refresh(); });
    $('#toggleHiddenBtn').addEventListener('click', ()=>{ showHidden=!showHidden; $('#hiddenState').textContent = showHidden? 'YES':'NO'; refresh(); })

    $('#exportBtn').addEventListener('click', exportJSON);
    $('#importFile').addEventListener('change', importJSON);

    // ====== ä¸€è¦§ ======
    async function refresh(){
      try{
        const p = new URLSearchParams();
        if($('#q').value.trim()) p.set('q', $('#q').value.trim());
        if($('#from').value) p.set('from', $('#from').value);
        if($('#to').value)   p.set('to',   $('#to').value);
        if(showHidden) p.set('includeHidden', '1');
        const data = await api(PATHS.list + (p.toString()?`?${p.toString()}`:''));
        const items = data.items || data || [];
        renderList(items);
        $('#count').textContent = items.length;
        toast('ä¸€è¦§ã‚’å–å¾—ã—ã¾ã—ãŸ');
      }catch(e){ console.error(e); toast('ä¸€è¦§å–å¾—ã«å¤±æ•—ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å¾©å…ƒã—ã¾ã™', false); const items = restoreLocal(); renderList(items); $('#count').textContent = items.length; }
    }

    function renderList(items){
      const tbody = $('#tbody');
      tbody.innerHTML = '';
      for(const e of items){
        const tr = document.createElement('tr');
        tr.className = e.hidden? 'hidden':'';
        const tagHtml = (e.tags||[]).map(t=>`<span class="pill">#${escapeHtml(t)}</span>`).join(' ');
        tr.innerHTML = `
          <td class="nowrap">${escapeHtml(e.date||'')}</td>
          <td>
            <div class="ellipsis"><b>${escapeHtml(e.title||'(ç„¡é¡Œ)')}</b></div>
            <div class="ellipsis" style="margin-top:4px;color:#d8deea">${escapeHtml((e.body||'').slice(0,120))}${(e.body||'').length>120?'â€¦':''}</div>
          </td>
          <td class="nowrap">${tagHtml}</td>
          <td class="nowrap">${moodIcon(e.mood)}</td>
          <td class="nowrap">
            <div class="flex">
              <button class="btn b-ghost" data-act="edit" data-id="${e.id}">âœ ç·¨é›†</button>
              <button class="btn b-ghost" data-act="toggle" data-id="${e.id}">${e.hidden?'ğŸ‘ è¡¨ç¤º':'ğŸ‘â€ğŸ—¨ éè¡¨ç¤º'}</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll('button[data-act]').forEach(b=> b.addEventListener('click', onRowAction));
    }

    async function onRowAction(ev){
      const btn = ev.currentTarget; const id = btn.dataset.id; const act = btn.dataset.act;
      if(act==='edit'){
        try{
          // NOTE: list endpointãŒååˆ†ãªã‚‰ãã®å ´ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ‹¾ã†æ–¹ãŒé€Ÿã„ã€‚ã“ã“ã§ã¯å†å–å¾—ä¾‹ã€‚
          const data = await api(PATHS.list+`?id=${encodeURIComponent(id)}`);
          const e = (data.items||[])[0] || data.entry || data; currentId = id; setForm(e); $('#updateBtn').disabled=false; $('#saveBtn').disabled=true; toast('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿');
        }catch(e){ console.error(e); toast('ç·¨é›†ç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—', false); }
      }
      if(act==='toggle'){
        try{ await api(PATHS.toggle(id), {method:'PATCH', body: JSON.stringify({})}); toast('è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡æ›¿ãˆã¾ã—ãŸ'); refresh(); } catch(e){ console.error(e); toast('åˆ‡æ›¿ã«å¤±æ•—', false); }
      }
    }

    // ====== ä¾¿åˆ©æ©Ÿèƒ½ï¼šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç”¨ï¼‰ ======
    function exportJSON(){
      const data = restoreLocal();
      const blob = new Blob([JSON.stringify({exportedAt:new Date().toISOString(), items:data}, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `diary-export-${Date.now()}.json`; a.click();
    }
    async function importJSON(ev){
      const file = ev.target.files?.[0]; if(!file) return;
      const text = await file.text();
      try{ const data = JSON.parse(text); if(Array.isArray(data.items)) { localStorage.setItem('DIARY_LOCAL_BACKUP', JSON.stringify(data.items)); toast('ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ'); refresh(); } else { toast('JSONå½¢å¼ãŒä¸æ­£ã§ã™', false); } } catch(e){ toast('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—', false) }
    }

    // ====== ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ======
    function backupLocal(kind, payload){
      const key='DIARY_LOCAL_BACKUP'; const arr = restoreLocal();
      if(kind==='create'){ const tempId = `local-${Date.now()}`; arr.unshift({...payload, id: tempId, createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()}); }
      if(kind==='update'){ const idx=arr.findIndex(x=>x.id===payload.id); if(idx>=0) arr[idx] = {...arr[idx], ...payload, updatedAt:new Date().toISOString()}; }
      localStorage.setItem(key, JSON.stringify(arr));
    }
    function restoreLocal(){ try{ const raw = localStorage.getItem('DIARY_LOCAL_BACKUP'); return raw? JSON.parse(raw): []; }catch{ return []; }

    }

    // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    function moodIcon(m){ return m==='good'? 'ğŸ˜€' : (m==='bad'? 'ğŸ˜' : 'ğŸ˜'); }

    // ====== åˆæœŸåŒ– ======
    (function init(){
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜
      $('#f-date').value = today();
      clearForm();
      refresh();
    })();
  </script>
</body>
</html>

<!-- =============================================
= ä»¥ä¸‹ã€Cloudflare D1 + Pages Functions ç”¨ API ä¸€å¼ =
= repo æ§‹æˆæ¡ˆï¼ˆä¾‹ï¼‰                            =
=
=  memo_save/
=  â”œâ”€ functions/
=  â”‚   â””â”€ api/
=  â”‚        â””â”€ diary/
=  â”‚             â”œâ”€ create.js   (POST /api/diary/create)
=  â”‚             â”œâ”€ list.js     (GET  /api/diary/list)
=  â”‚             â”œâ”€ update.js   (PUT  /api/diary/update/:id)
=  â”‚             â”œâ”€ toggle.js   (PATCH /api/diary/toggle/:id)
=  â”‚             â””â”€ random.js   (GET  /api/diary/random)
=  â”œâ”€ public/
=  â”‚   â””â”€ diary.html  â† ã“ã®ãƒ•ãƒ­ãƒ³ãƒˆ
=  â”œâ”€ wrangler.toml   â† D1 ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: DB
=  â””â”€ migrations/
=      â””â”€ 001_diary.sql
============================================= -->

<!--  migrations/001_diary.sql  -->
<script type="text/plain" data-filename="migrations/001_diary.sql">
CREATE TABLE IF NOT EXISTS diary (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date TEXT NOT NULL,              -- YYYY-MM-DD
  title TEXT,
  body TEXT NOT NULL,
  tags TEXT,                       -- JSON æ–‡å­—åˆ—æ¨å¥¨
  mood TEXT NOT NULL DEFAULT 'okay', -- good / okay / bad
  favorite INTEGER NOT NULL DEFAULT 0,
  hidden INTEGER NOT NULL DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);
CREATE INDEX IF NOT EXISTS idx_diary_date ON diary(date DESC);
CREATE INDEX IF NOT EXISTS idx_diary_hidden ON diary(hidden);
</script>

<!--  functions/api/diary/_util.js  å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆä»»æ„ï¼‰ -->
<script type="text/plain" data-filename="functions/api/diary/_util.js">
export const json = (data, init={}) => new Response(JSON.stringify(data), {headers:{"content-type":"application/json; charset=utf-8"}, ...init});
export const bad = (message, status=400) => json({ok:false, error: message}, {status});
export const nowISO = () => new Date().toISOString();
export const safeBool = (v) => v===true || v===1 || v==='1' || v==='true';
</script>

<!--  functions/api/diary/create.js  POST /api/diary/create  -->
<script type="text/plain" data-filename="functions/api/diary/create.js">
import { json, bad, nowISO } from "../_util.js";

export async function onRequestPost({ request, env }){
  const db = env.DB; // D1 ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
  let payload;
  try{ payload = await request.json(); } catch{ return bad("invalid JSON"); }
  const e = payload?.entry || {};
  const date = e.date || nowISO().slice(0,10);
  const title = e.title ?? "";
  const body = e.body ?? "";
  if(!body) return bad("body is required");
  const tags = JSON.stringify(Array.isArray(e.tags)? e.tags : (typeof e.tags==="string" && e.tags.trim()? e.tags.split(",").map(s=>s.trim()) : []));
  const mood = (e.mood||"okay").toLowerCase();
  const favorite = e.favorite?1:0;
  const hidden = e.hidden?1:0;
  const now = nowISO();

  const stmt = db.prepare(`
    INSERT INTO diary (date,title,body,tags,mood,favorite,hidden,created_at,updated_at)
    VALUES (?,?,?,?,?,?,?,?,?)
  `).bind(date,title,body,tags,mood,favorite,hidden,now,now);
  const result = await stmt.run();
  return json({ ok:true, id: result.lastRowId });
}
</script>

<!--  functions/api/diary/list.js  GET /api/diary/list  -->
<script type="text/plain" data-filename="functions/api/diary/list.js">
import { json } from "../_util.js";

export async function onRequestGet({ request, env }){
  const { searchParams } = new URL(request.url);
  const id = searchParams.get("id");
  const q = (searchParams.get("q")||"").trim();
  const from = searchParams.get("from");
  const to = searchParams.get("to");
  const includeHidden = searchParams.get("includeHidden") === "1";
  const limit = Math.min(200, parseInt(searchParams.get("limit")||"100",10));
  const offset = Math.max(0, parseInt(searchParams.get("offset")||"0",10));

  const db = env.DB;
  let where = [];
  let binds = [];

  if(id){ where.push("id = ?"); binds.push(id); }
  if(q){
    // title/body/tags ã‚’ LIKE æ¤œç´¢
    where.push("(title LIKE ? OR body LIKE ? OR tags LIKE ?)");
    binds.push(`%${q}%`,`%${q}%`,`%${q}%`);
  }
  if(from){ where.push("date >= ?"); binds.push(from); }
  if(to){ where.push("date <= ?"); binds.push(to); }
  if(!includeHidden){ where.push("hidden = 0"); }

  const sql = `SELECT * FROM diary ${where.length?`WHERE ${where.join(" AND ")}`:""} ORDER BY date DESC, created_at DESC LIMIT ? OFFSET ?`;
  binds.push(limit, offset);
  const rows = await db.prepare(sql).bind(...binds).all();
  return json({ ok:true, items: rows.results || [] });
}
</script>

<!--  functions/api/diary/update.js  PUT /api/diary/update/:id  -->
<script type="text/plain" data-filename="functions/api/diary/update.js">
import { json, bad, nowISO } from "../_util.js";

export async function onRequestPut({ request, env, params }){
  const db = env.DB; const id = params?.id;
  if(!id) return bad("id is required", 400);
  let payload; try{ payload = await request.json(); } catch{ return bad("invalid JSON"); }
  const e = payload?.entry || {};
  const date = e.date; // ä»»æ„
  const title = e.title; // ä»»æ„
  const body = e.body; // ä»»æ„
  const tags = Array.isArray(e.tags)? JSON.stringify(e.tags) : (typeof e.tags==="string"? JSON.stringify(e.tags.split(",").map(s=>s.trim())) : undefined);
  const mood = e.mood; // ä»»æ„
  const favorite = (e.favorite===undefined? undefined : (e.favorite?1:0));
  const hidden = (e.hidden===undefined? undefined : (e.hidden?1:0));

  const fields = [];
  const binds = [];
  if(date!==undefined){ fields.push("date = ?"); binds.push(date); }
  if(title!==undefined){ fields.push("title = ?"); binds.push(title); }
  if(body!==undefined){ fields.push("body = ?"); binds.push(body); }
  if(tags!==undefined){ fields.push("tags = ?"); binds.push(tags); }
  if(mood!==undefined){ fields.push("mood = ?"); binds.push(mood); }
  if(favorite!==undefined){ fields.push("favorite = ?"); binds.push(favorite); }
  if(hidden!==undefined){ fields.push("hidden = ?"); binds.push(hidden); }
  fields.push("updated_at = ?"); binds.push(nowISO());
  if(fields.length===1) return bad("no fields to update");

  const sql = `UPDATE diary SET ${fields.join(",")} WHERE id = ?`;
  binds.push(id);
  const result = await db.prepare(sql).bind(...binds).run();
  return json({ ok:true, changes: result.changes });
}
</script>

<!--  functions/api/diary/toggle.js  PATCH /api/diary/toggle/:id  -->
<script type="text/plain" data-filename="functions/api/diary/toggle.js">
import { json, bad, nowISO } from "../_util.js";

export async function onRequestPatch({ request, env, params }){
  const db = env.DB; const id = params?.id; if(!id) return bad("id is required");
  let body; try{ body = await request.json(); } catch{ body = {}; }
  const explicit = body?.hidden; // true/false ã®å ´åˆã¯ãã®å€¤ã«ã€‚æœªæŒ‡å®šãªã‚‰ãƒˆã‚°ãƒ«ã€‚

  // ç¾åœ¨å€¤ã‚’å–å¾—
  const cur = await db.prepare("SELECT hidden FROM diary WHERE id = ?").bind(id).first();
  if(!cur) return bad("not found", 404);
  const next = (explicit===undefined)? (cur.hidden?0:1) : (explicit?1:0);

  const result = await db.prepare("UPDATE diary SET hidden = ?, updated_at = ? WHERE id = ?")
    .bind(next, nowISO(), id).run();
  return json({ ok:true, hidden: !!next, changes: result.changes });
}
</script>

<!--  functions/api/diary/random.js  GET /api/diary/random  -->
<script type="text/plain" data-filename="functions/api/diary/random.js">
import { json } from "../_util.js";

export async function onRequestGet({ request, env }){
  const { searchParams } = new URL(request.url);
  const includeHidden = searchParams.get("includeHidden") === "1";
  const sql = `SELECT * FROM diary ${includeHidden?"":"WHERE hidden = 0"} ORDER BY RANDOM() LIMIT 1`;
  const row = await env.DB.prepare(sql).first();
  return json({ ok:true, entry: row || null });
}
</script>

