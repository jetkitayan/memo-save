<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>文章保存ミニアプリ</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; background:#fafafa; }
    h1 { margin: 0 0 16px; }
    form, .list { max-width: 720px; }
    textarea { width: 100%; min-height: 120px; padding: 12px; font-size: 16px; }
    button { padding: 10px 16px; font-size: 15px; border-radius: 8px; border: 1px solid #ccc; background:#fff; cursor:pointer; }
    button:hover { background:#f0f0f0; }
    .toolbar { display:flex; gap:10px; align-items:center; margin: 8px 0 20px; }
    .item { background:#fff; border:1px solid #e5e5e5; border-radius:12px; padding:14px; margin:10px 0; }
    .meta { font-size: 12px; color:#666; margin-top:8px; }
    .row { display:flex; gap:8px; align-items:center; }
    input[type="number"]{ width: 100px; padding: 6px 8px; }
  </style>
</head>
<body>
  <h1>文章の登録＆一覧</h1>

  <form id="form">
    <label for="text">文章</label>
    <textarea id="text" placeholder="ここに文章を入力…"></textarea>
    <div class="toolbar">
      <button type="submit">保存する</button>
      <span id="msg"></span>
    </div>
  </form>

  <div class="row">
    <label for="limit">一覧の表示件数</label>
    <input id="limit" type="number" value="50" min="1" max="500">
    <button id="reload">一覧取得</button>
  </div>

  <div class="list" id="list"></div>

  <script>
    // ★ あなたのAPIエンドポイント
    const API_BASE = "https://memo-save-api.jetkitayan.workers.dev";

    const form = document.getElementById("form");
    const text = document.getElementById("text");
    const msg = document.getElementById("msg");
    const list = document.getElementById("list");
    const limitInput = document.getElementById("limit");
    const reloadBtn = document.getElementById("reload");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "";
      const body = { text: text.value.trim() };
      if (!body.text) { msg.textContent = "文章が空です。"; return; }

      const res = await fetch(`${API_BASE}/api/items`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json();
      if (data.ok) { msg.textContent = "保存しました。"; text.value = ""; await loadList(); }
      else { msg.textContent = data.error || "保存に失敗しました。"; }
    });

    reloadBtn.addEventListener("click", loadList);

    async function loadList() {
      const limit = Number(limitInput.value || 50);
      const res = await fetch(`${API_BASE}/api/items?limit=${encodeURIComponent(limit)}`);
      const data = await res.json();
      list.innerHTML = "";
      if (!data.ok) { list.textContent = "取得に失敗しました。"; return; }
      if (data.items.length === 0) { list.textContent = "登録はまだありません。"; return; }
      for (const item of data.items) {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>${escapeHtml(item.text).replace(/\n/g, "<br>")}</div>
          <div class="meta">#${item.id} / ${item.created_at}</div>`;
        list.appendChild(div);
      }
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // 初回ロード
    loadList();
  </script>
</body>
</html>
