<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ¡ãƒ¢ä¿å­˜ã‚¢ãƒ—ãƒª</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; background:#fafafa; }
    h1 { margin: 0 0 16px; }
    form, .list { max-width: 720px; }
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      font-size: 16px;
      box-sizing: border-box; /* â† ã“ã‚Œã‚’è¿½åŠ  */
    }
    select { padding: 8px 10px; font-size: 15px; border-radius: 6px; }
    button { padding: 10px 16px; font-size: 15px; border-radius: 8px; border: 1px solid #ccc; background:#fff; cursor:pointer; }
    button:hover { background:#f0f0f0; }
    .toolbar { display:flex; flex-wrap: wrap; gap:10px; align-items:center; margin: 8px 0 20px; }
    .item { background:#fff; border:1px solid #e5e5e5; border-radius:12px; padding:14px; margin:10px 0; }
    .meta { font-size: 12px; color:#666; margin-top:8px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    input[type="number"]{ width: 100px; padding: 6px 8px; }
    .right { margin-left: auto; }
    .muted { color:#666; font-size:12px; }
    .del-btn { margin-left: 10px; border-color:#f33; color:#f33; }
    .del-btn:hover { background:#fee; }
    .edit { margin-top:8px; display:none; }
    .edit textarea { width:100%; min-height:120px; padding:8px; }
    .edit .row { margin-top:6px; }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      margin: 2px 4px 0 0;
      border-radius: 999px;
      border: 1px solid #ccc;
      font-size: 12px;
      background: #fff;
    }
    .chip button {
      margin-left: 4px;
      padding: 0 4px;
      font-size: 11px;
      border: none;
      background: transparent;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>ãƒ¡ãƒ¢ä¿å­˜</h1>

  <form id="form">
    <label for="text">æ–‡ç« </label>
    <textarea id="text" placeholder="ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›â€¦"></textarea>

    <div class="toolbar">
      <label for="category">åˆ†é¡ï¼š</label>
      <select id="category">
        <option value="ãƒã‚¹ã‚±">ãƒã‚¹ã‚±</option>
        <option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
        <option value="ä»•äº‹">ä»•äº‹</option>
        <option value="å‹‰å¼·">å‹‰å¼·</option>
        <option value="å‚™å¿˜éŒ²">å‚™å¿˜éŒ²</option>
        <option value="ãã®ä»–" selected>ãã®ä»–</option>
      </select>

      <button type="submit">ä¿å­˜ã™ã‚‹</button>
      <span id="msg"></span>
      <span class="right muted" id="authStatus"></span>
      <button type="button" id="logoutBtn" title="ä¿å­˜ã—ã¦ã‚ã‚‹èªè¨¼æƒ…å ±ã‚’æ¶ˆã—ã¾ã™">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </form>

  <!-- â˜… åˆ†é¡ãƒã‚¹ã‚¿ç·¨é›†ã‚¨ãƒªã‚¢ -->
  <div class="row" style="margin:8px 0 16px;">
    <label>åˆ†é¡ãƒã‚¹ã‚¿ï¼š</label>
    <input id="newCategory" type="text" placeholder="åˆ†é¡åã‚’å…¥åŠ›" />
    <button type="button" id="addCategoryBtn">è¿½åŠ </button>
    <button type="button" id="resetCategoryBtn">åˆæœŸçŠ¶æ…‹ã«æˆ»ã™</button>
  </div>
  <div id="categoryChips" class="row muted" style="margin-bottom:16px; flex-wrap:wrap;"></div>
  
  <div class="row">
    <label for="limit">ä¸€è¦§ã®è¡¨ç¤ºä»¶æ•°</label>
    <input id="limit" type="number" value="50" min="1" max="500">
    <button id="reload">ä¸€è¦§å–å¾—</button>

    <!-- â˜… ã“ã“ã‚’è¿½åŠ ï¼šä¸€è¦§ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ -->
    <label style="display:flex; gap:6px; align-items:center;">
      ä¸€è¦§ã‚«ãƒ†ã‚´ãƒªï¼š
      <select id="filterCategory">
        <option value="">ï¼ˆã™ã¹ã¦ï¼‰</option>
      </select>
    </label>

    <label style="display:flex; gap:6px; align-items:center;">
      <input type="checkbox" id="showAllItems"> éè¡¨ç¤ºã‚‚å«ã‚ã‚‹
    </label>
    <button id="export">CSVå‡ºåŠ›</button>
  </div>
  
  <div class="row" style="margin-top:16px; margin-bottom:16px;">
    <label>åˆ†é¡ã‚’é¸æŠï¼š</label>
    <select id="randCategory">
      <option value="ãƒã‚¹ã‚±">ãƒã‚¹ã‚±</option>
      <option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
      <option value="ä»•äº‹">ä»•äº‹</option>
      <option value="å‹‰å¼·">å‹‰å¼·</option>
      <option value="ãã®ä»–">ãã®ä»–</option>
    </select>
    <label style="display:flex; gap:6px; align-items:center; margin-left:8px;">
      <input type="checkbox" id="randAll"> å…¨ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰
    </label>
    <button id="showRandom">ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º</button>
  </div>
  
  <div id="randomResult" class="item" style="display:none; background:#f7fff7;"></div>
    
  <div class="list" id="list"></div>

  <script>
    const API_BASE = "https://memo-save-api.jetkitayan.workers.dev";

    const form = document.getElementById("form");

    // ===== åˆ†é¡ãƒã‚¹ã‚¿ï¼ˆã‚³ãƒ³ãƒœãƒœãƒƒã‚¯ã‚¹ã®è‡ªç”±ç·¨é›† + URLåˆæœŸå€¤ï¼‰ =====
    const DEFAULT_CATEGORIES = ["ãƒã‚¹ã‚±","ç”Ÿæ´»","ä»•äº‹","å‹‰å¼·","å‚™å¿˜éŒ²","ãã®ä»–"];

    function loadCategories() {
      try {
        const saved = JSON.parse(localStorage.getItem("memo_categories") || "null");
        if (Array.isArray(saved) && saved.length > 0) {
          return saved;
        }
      } catch (_) {}
      return [...DEFAULT_CATEGORIES];
    }

    let categories = loadCategories();

    const newCatInput    = document.getElementById("newCategory");
    const addCatBtn      = document.getElementById("addCategoryBtn");
    const resetCatBtn    = document.getElementById("resetCategoryBtn");
    const catChips       = document.getElementById("categoryChips");

    function saveCategories() {
      localStorage.setItem("memo_categories", JSON.stringify(categories));
    }

    function ensureCategoryInList(name) {
      if (!name) return;
      if (!categories.includes(name)) {
        categories.push(name);
        saveCategories();
      }
    }

    function renderCategorySelectOptions(selectEl, selectedValue) {
      if (!selectEl) return;
      const current = selectedValue ?? selectEl.value ?? "ãã®ä»–";
      selectEl.innerHTML = "";
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        if (cat === current) opt.selected = true;
        selectEl.appendChild(opt);
      });
    }

    // ã™ã¹ã¦ã®ã‚³ãƒ³ãƒœãƒœãƒƒã‚¯ã‚¹ã®ä¸­èº«ã‚’ categories ã‹ã‚‰å†æç”»
    function renderAllCategorySelects() {
      renderCategorySelectOptions(category, category.value || "ãã®ä»–");
      if (typeof randCategory !== "undefined") {
        renderCategorySelectOptions(randCategory, randCategory.value || "ãã®ä»–");
      }
    }

    function renderCategoryChips() {
      if (!catChips) return;
      catChips.innerHTML = "";
      categories.forEach(name => {
        const span = document.createElement("span");
        span.className = "chip";
        span.innerHTML = `${escapeHtml(name)} <button type="button" class="chip-del" data-name="${escapeHtml(name)}">Ã—</button>`;
        catChips.appendChild(span);
      });
    }

    // è¿½åŠ ãƒœã‚¿ãƒ³
    if (addCatBtn) {
      addCatBtn.addEventListener("click", () => {
        const name = (newCatInput.value || "").trim();
        if (!name) return;
        if (categories.includes(name)) {
          alert("ã™ã§ã«å­˜åœ¨ã™ã‚‹åˆ†é¡ã§ã™ã€‚");
          return;
        }
        categories.push(name);
        saveCategories();
        renderAllCategorySelects();
        renderCategoryChips();
        newCatInput.value = "";
      });
    }

    // åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
    if (resetCatBtn) {
      resetCatBtn.addEventListener("click", () => {
        if (!confirm("åˆ†é¡ãƒã‚¹ã‚¿ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;
        categories = [...DEFAULT_CATEGORIES];
        saveCategories();
        renderAllCategorySelects();
        renderCategoryChips();
      });
    }

    // ãƒãƒƒãƒ—ã®Ã—ã§å‰Šé™¤ï¼ˆã€Œãã®ä»–ã€ã¯å®ˆã‚‹ï¼‰
    if (catChips) {
      catChips.addEventListener("click", (e) => {
        const btn = e.target.closest(".chip-del");
        if (!btn) return;
        const name = btn.dataset.name;
        if (!name) return;
        if (name === "ãã®ä»–") {
          alert("ã€Œãã®ä»–ã€ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
          return;
        }
        if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        categories = categories.filter(c => c !== name);
        saveCategories();
        renderAllCategorySelects();
        renderCategoryChips();
      });
    }

    // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åˆæœŸã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®š (?category=...)
    function applyInitialCategoryFromUrl() {
      const params = new URLSearchParams(location.search);
      const cat = params.get("category");
      if (!cat) return;

      // URLã‹ã‚‰æ¥ãŸåˆ†é¡ã‚’ãƒã‚¹ã‚¿ã«å«ã‚ã‚‹
      ensureCategoryInList(cat);
      renderAllCategorySelects();

      // ãƒ¡ã‚¤ãƒ³å…¥åŠ›ãƒ»ãƒ©ãƒ³ãƒ€ãƒ ã®åˆæœŸå€¤ã‚’ã‚»ãƒƒãƒˆ
      category.value = cat;
      if (typeof randCategory !== "undefined" && randCategory) {
        randCategory.value = cat;
      }
    }

    const text = document.getElementById("text");
    const category = document.getElementById("category");
    const msg = document.getElementById("msg");
    const list = document.getElementById("list");
    const limitInput = document.getElementById("limit");
    const reloadBtn = document.getElementById("reload");
    const logoutBtn = document.getElementById("logoutBtn");
    const authStatus = document.getElementById("authStatus");
    const exportBtn = document.getElementById("export");
    const showAllItems = document.getElementById("showAllItems");

    // ===== Basicèªè¨¼ã¾ã‚ã‚Š =====
    let authHeader = localStorage.getItem("memo_auth") || "";

    function setAuth(user, pass){
      authHeader = "Basic " + btoa(`${user}:${pass}`);
      localStorage.setItem("memo_auth", authHeader);
      authStatus.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼ˆBasicï¼‰`;
    }
    function clearAuth(){
      authHeader = "";
      localStorage.removeItem("memo_auth");
      authStatus.textContent = `æœªãƒ­ã‚°ã‚¤ãƒ³`;
    }
    async function ensureAuthInteractive() {
      if (authHeader) return true;
      const u = prompt("ãƒ¦ãƒ¼ã‚¶ãƒ¼å");
      if (u === null) return false;
      const p = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
      if (p === null) return false;
      setAuth(u, p);
      return true;
    }

    async function apiFetch(path, options = {}, retryOn401 = true) {
      const headers = {
        "Content-Type": "application/json",
        "Authorization": authHeader || "",
        ...(options.headers || {}),
      };
      const res = await fetch(`${API_BASE}${path}`, { ...options, headers });

      // ğŸ‘‡ã“ã“ã‚’è¿½åŠ ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å…¨éƒ¨ãƒ­ã‚°ã«å‡ºã™ï¼‰
      const clone = res.clone();
      const text = await clone.text();
      console.log("fetch", path, "â†’", res.status, text);
      
      if (res.status === 401 && retryOn401) {
        clearAuth();
        const ok = await ensureAuthInteractive();
        if (!ok) return res;
        return apiFetch(path, options, false);
      }
      return res;
    }

    (function initAuth(){
      authStatus.textContent = authHeader ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼ˆBasicï¼‰` : `æœªãƒ­ã‚°ã‚¤ãƒ³`;
    })();

    logoutBtn.addEventListener("click", () => {
      clearAuth();
      alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚æ“ä½œæ™‚ã«å†åº¦èªè¨¼ã‚’æ±‚ã‚ã¾ã™ã€‚");
    });

    // ===== ä¿å­˜ =====
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "";

      if (!authHeader) {
        const ok = await ensureAuthInteractive();
        if (!ok) { msg.textContent = "èªè¨¼ãŒå¿…è¦ã§ã™ã€‚"; return; }
      }

      const body = {
        text: text.value.trim(),
        category: category.value
      };
      if (!body.text) { msg.textContent = "æ–‡ç« ãŒç©ºã§ã™ã€‚"; return; }

      const res = await apiFetch(`/api/items`, {
        method: "POST",
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (res.ok && data.ok) {
        msg.textContent = "ä¿å­˜ã—ã¾ã—ãŸã€‚";
        text.value = "";
        await loadList();
      } else {
        msg.textContent = (data && data.error) ? data.error : `ä¿å­˜ã«å¤±æ•—ï¼ˆHTTP ${res.status})`;
      }
    });

    // ===== CSVå‡ºåŠ› =====
    exportBtn.addEventListener("click", async () => {
      if (!authHeader) {
        const ok = await ensureAuthInteractive();
        if (!ok) { alert("èªè¨¼ãŒå¿…è¦ã§ã™"); return; }
      }
      const all = (showAllItems && showAllItems.checked) ? "?all=1" : "";
      const res = await apiFetch(`/api/export_csv${all}`);
      if (!res.ok) {
        alert(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰`);
        return;
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `memo_items_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    const showRandomBtn = document.getElementById("showRandom");
    const randCategory  = document.getElementById("randCategory");
    const randAll       = document.getElementById("randAll");
    const randomResult  = document.getElementById("randomResult");
    
    // ãƒã‚§ãƒƒã‚¯æ™‚ã¯ã‚«ãƒ†ã‚´ãƒªé¸æŠã‚’ç„¡åŠ¹åŒ–ï¼ˆUIä¸Šã®åˆ†ã‹ã‚Šã‚„ã™ã•ï¼‰
    randAll.addEventListener("change", () => {
      randCategory.disabled = randAll.checked;
    });
    
    showRandomBtn.addEventListener("click", async () => {
      if (!authHeader) {
        const ok = await ensureAuthInteractive();
        if (!ok) return;
      }
      await doReroll();
    });

    // ===== ä¸€è¦§ =====
    reloadBtn.addEventListener("click", loadList);

    async function loadList() {
      if (!authHeader) {
        const ok = await ensureAuthInteractive();
        if (!ok) { list.textContent = "èªè¨¼ãŒå¿…è¦ã§ã™ã€‚"; return; }
      }

      const limit = Number(limitInput.value || 50);
      const all = (showAllItems && showAllItems.checked) ? "&all=1" : "";
      const res = await apiFetch(`/api/items?limit=${encodeURIComponent(limit)}${all}`);
      const data = await res.json().catch(() => ({}));
      list.innerHTML = "";

      if (!res.ok || !data.ok) {
        list.textContent = (data && data.error) ? data.error : `å–å¾—ã«å¤±æ•—ï¼ˆHTTP ${res.status})`;
        return;
      }
      if (!data.items || data.items.length === 0) {
        list.textContent = "ç™»éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚";
        return;
      }

      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸ item ã® category ã‚‚ãƒã‚¹ã‚¿ã«å–ã‚Šè¾¼ã‚€
      for (const it of data.items) {
        ensureCategoryInList(it.category || "ãã®ä»–");
      }
      renderAllCategorySelects();
      renderCategoryChips();

      for (const item of data.items) {
        const div = document.createElement("div");
        div.className = "item";
      
        const jstC = new Date(item.created_at).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
        const jstU = new Date(item.updated_at).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
        const visible = (item.status ?? 1) === 1;
      
        div.innerHTML = `
          <div class="view">
            <div>${escapeHtml(item.text).replace(/\n/g, "<br>")}</div>
            <div class="meta">
              #${item.id} / ä½œæˆ:${jstC} / æœ€çµ‚æ›´æ–°:${jstU} / [${escapeHtml(item.category || "ãã®ä»–")}]
              <button class="edit-btn" data-id="${item.id}" style="margin-left:8px;">ç·¨é›†</button>
              <button class="toggle-vis" data-id="${item.id}" style="margin-left:6px;">
                ${visible ? "éè¡¨ç¤ºã«ã™ã‚‹" : "è¡¨ç¤ºã«ã™ã‚‹"}
              </button>
              <button class="del-btn" data-id="${item.id}" style="margin-left:6px; border-color:#f33; color:#f33;">å‰Šé™¤</button>
            </div>
          </div>
      
          <div class="edit">
            <textarea class="edit-text"></textarea>
            <div class="row">
              <label>åˆ†é¡ï¼š</label>
              <select class="edit-cat">
                ${categories.map(opt => `<option value="${opt}" ${opt===(item.category||"ãã®ä»–")?"selected":""}>${opt}</option>`).join("")}
              </select>
              <span class="right">
                <button class="save-btn" data-id="${item.id}">ä¿å­˜</button>
                <button class="cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              </span>
            </div>
          </div>
        `;
      
        // åˆæœŸå€¤ï¼ˆç”Ÿãƒ†ã‚­ã‚¹ãƒˆï¼‰
        div.querySelector(".edit-text").value = item.text;
  
        // ç·¨é›†è¡¨ç¤ºåˆ‡æ›¿
        div.querySelector(".edit-btn").addEventListener("click", () => {
          div.querySelector(".view").style.display = "none";
          div.querySelector(".edit").style.display = "block";
        });
        div.querySelector(".cancel-btn").addEventListener("click", () => {
          div.querySelector(".edit").style.display = "none";
          div.querySelector(".view").style.display = "block";
        });
      
        // ä¿å­˜ï¼ˆPUT /api/items/:idï¼‰
        div.querySelector(".save-btn").addEventListener("click", async (e) => {
          const id = Number(e.currentTarget.getAttribute("data-id"));
          const newText = div.querySelector(".edit-text").value;
          const newCat  = div.querySelector(".edit-cat").value;
      
          const r = await apiFetch(`/api/items/${id}`, {
            method: "PUT",
            body: JSON.stringify({ text: newText, category: newCat })
          });
          const d = await r.json().catch(()=> ({}));
          if (r.ok && d.ok) {
            await loadList();
          } else {
            alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        });
      
        // è¡¨ç¤º/éè¡¨ç¤º åˆ‡æ›¿
        div.querySelector(".toggle-vis").addEventListener("click", async (e) => {
          const id = Number(e.currentTarget.getAttribute("data-id"));
          const nextVal = visible ? 0 : 1;
          const r = await apiFetch(`/api/items/${id}`, {
            method: "PUT",
            body: JSON.stringify({ status: nextVal })
          });
          const d = await r.json().catch(()=> ({}));
          if (r.ok && d.ok) { await loadList(); }
          else alert("è¡¨ç¤ºçŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
        });
      
        // å‰Šé™¤
        div.querySelector(".del-btn").addEventListener("click", async (e) => {
          const id = Number(e.currentTarget.getAttribute("data-id"));
          if (!confirm(`#${id} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
          const delRes = await apiFetch(`/api/items/${id}`, { method: "DELETE" });
          const delData = await delRes.json().catch(() => ({}));
          if (delRes.ok && delData.ok) await loadList();
          else alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        });
      
        list.appendChild(div);
      }
    }

function renderRandom(item){
  randomResult.style.display = "block";
  randomResult.dataset.id = item.id;

  const jstC = new Date(item.created_at).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
  const jstU = new Date(item.updated_at).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
  const visible = item.status === 1;
  const cat = item.category || "ãã®ä»–";

  // ã“ã®ãƒ©ãƒ³ãƒ€ãƒ ä»¶ã®ã‚«ãƒ†ã‚´ãƒªã‚‚ãƒã‚¹ã‚¿ã«å–ã‚Šè¾¼ã‚“ã§ãŠã
  ensureCategoryInList(cat);
  renderAllCategorySelects();
  renderCategoryChips();

  randomResult.innerHTML = `
    <div class="view">
      <div>${escapeHtml(item.text).replace(/\n/g, "<br>")}</div>
      <div class="meta">
        #${item.id} / ä½œæˆ:${jstC} / æœ€çµ‚æ›´æ–°:${jstU} / [${escapeHtml(cat)}]
        <button id="rndEdit" style="margin-left:8px;">ç·¨é›†</button>
        <button id="rndReroll" style="margin-left:6px;">ã‚‚ã†ä¸€å›</button>
        <button id="rndToggle" style="margin-left:6px;">
          ${visible ? "éè¡¨ç¤ºã«ã™ã‚‹" : "è¡¨ç¤ºã«ã™ã‚‹"}
        </button>
        <button id="rndDelete" style="margin-left:6px; border-color:#f33; color:#f33;">å‰Šé™¤</button>
      </div>
    </div>
    <div class="edit" style="display:none;">
      <textarea id="rndText"></textarea>
      <div class="row">
        <label>åˆ†é¡ï¼š</label>
        <select id="rndCat">
          ${categories.map(opt => `<option value="${opt}" ${opt===cat?"selected":""}>${opt}</option>`).join("")}
        </select>
        <span class="right">
          <button id="rndSave">ä¿å­˜</button>
          <button id="rndCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </span>
      </div>
    </div>
  `;

  // ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸå€¤
  document.getElementById("rndText").value = item.text;

  // ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©
  document.getElementById("rndEdit").addEventListener("click", () => {
    randomResult.querySelector(".view").style.display = "none";
    randomResult.querySelector(".edit").style.display = "block";
  });
  document.getElementById("rndCancel").addEventListener("click", () => {
    randomResult.querySelector(".edit").style.display = "none";
    randomResult.querySelector(".view").style.display = "block";
  });

  document.getElementById("rndSave").addEventListener("click", async () => {
    const id   = Number(randomResult.dataset.id);
    const text = document.getElementById("rndText").value;
    const cat  = document.getElementById("rndCat").value;

    const r = await apiFetch(`/api/items/${id}`, {
      method: "PUT",
      body: JSON.stringify({ text, category: cat })
    });
    const d = await r.json().catch(()=> ({}));
    if (r.ok && d.ok) {
      // æœ€æ–°çŠ¶æ…‹ã‚’1ä»¶å–å¾—ã—ã¦æç”»ã—ç›´ã™
      const res2 = await apiFetch(`/api/items/${id}`);
      const data2 = await res2.json().catch(()=> ({}));
      if (res2.ok && data2.ok) renderRandom(data2.item);
      await loadList(); // ä¸€è¦§ã‚‚æ›´æ–°ï¼ˆupdated_atåæ˜ ï¼‰
    } else {
      alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  document.getElementById("rndToggle").addEventListener("click", async () => {
    const id = Number(randomResult.dataset.id);
    const nextVal = visible ? 0 : 1;
    const r = await apiFetch(`/api/items/${id}`, {
      method: "PUT",
      body: JSON.stringify({ status: nextVal })
    });
    const d = await r.json().catch(()=> ({}));
    if (r.ok && d.ok) {
      // åæ˜ å¾Œã€åŒã˜æ¡ä»¶ã§å†æŠ½é¸ï¼ˆéè¡¨ç¤ºã«ã—ãŸã‚‰è¦‹ãˆãªããªã‚‹ã®ã§ï¼‰
      await doReroll();
      await loadList();
    } else {
      alert("è¡¨ç¤ºçŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  document.getElementById("rndDelete").addEventListener("click", async () => {
    const id = Number(randomResult.dataset.id);
    if (!confirm(`#${id} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    const r = await apiFetch(`/api/items/${id}`, { method: "DELETE" });
    const d = await r.json().catch(()=> ({}));
    if (r.ok && d.ok) {
      randomResult.style.display = "none";
      await loadList();
    } else {
      alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  document.getElementById("rndReroll").addEventListener("click", doReroll);
}

async function doReroll(){
  // ç›´å‰ã®UIçŠ¶æ…‹ï¼ˆå…¨ã‚«ãƒ†ã‚´ãƒª or æŒ‡å®šã‚«ãƒ†ã‚´ãƒªï¼‰ã«å¾“ã£ã¦å†æŠ½é¸
  const useAll = randAll && randAll.checked;
  const cat = randCategory ? randCategory.value : "ãã®ä»–";
  const qs = useAll ? "" : `?category=${encodeURIComponent(cat)}`;

  const res = await apiFetch(`/api/items/random${qs}`);
  const data = await res.json().catch(()=> ({}));
  if (res.ok && data.ok) renderRandom(data.item);
  else {
    randomResult.style.display = "block";
    randomResult.textContent = data.error || `å†å–å¾—ã«å¤±æ•—ï¼ˆHTTP ${res.status})`;
  }
}
    
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // åˆå›ã®ã‚«ãƒ†ã‚´ãƒªUIæç”»ï¼ˆrandCategory å®šç¾©å¾Œï¼‰
    renderAllCategorySelects();
    renderCategoryChips();
    applyInitialCategoryFromUrl();

    // åˆå›ãƒ­ãƒ¼ãƒ‰
    loadList();

  </script>
</body>
</html>
