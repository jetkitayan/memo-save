<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>文章保存ミニアプリ</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; background:#fafafa; }
    h1 { margin: 0 0 16px; }
    form, .list { max-width: 720px; }
    textarea { width: 100%; min-height: 120px; padding: 12px; font-size: 16px; }
    select { padding: 8px 10px; font-size: 15px; border-radius: 6px; }
    button { padding: 10px 16px; font-size: 15px; border-radius: 8px; border: 1px solid #ccc; background:#fff; cursor:pointer; }
    button:hover { background:#f0f0f0; }
    .toolbar { display:flex; flex-wrap: wrap; gap:10px; align-items:center; margin: 8px 0 20px; }
    .item { background:#fff; border:1px solid #e5e5e5; border-radius:12px; padding:14px; margin:10px 0; }
    .meta { font-size: 12px; color:#666; margin-top:8px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    input[type="number"]{ width: 100px; padding: 6px 8px; }
    .right { margin-left: auto; }
    .muted { color:#666; font-size:12px; }
    .del-btn { margin-left: 10px; border-color:#f33; color:#f33; }
    .del-btn:hover { background:#fee; }
    .edit { margin-top:8px; display:none; }
    .edit textarea { width:100%; min-height:120px; padding:8px; }
    .edit .row { margin-top:6px; }
  </style>
</head>
<body>
  <h1>文章の登録＆一覧</h1>

  <form id="form">
    <label for="text">文章</label>
    <textarea id="text" placeholder="ここに文章を入力…"></textarea>

    <div class="toolbar">
      <label for="category">分類：</label>
      <select id="category">
        <option value="バスケ">バスケ</option>
        <option value="生活">生活</option>
        <option value="仕事">仕事</option>
        <option value="勉強">勉強</option>
        <option value="その他" selected>その他</option>
      </select>

      <button type="submit">保存する</button>
      <span id="msg"></span>
      <span class="right muted" id="authStatus"></span>
      <button type="button" id="logoutBtn" title="保存してある認証情報を消します">ログアウト</button>
    </div>
  </form>

  <div class="row">
    <label for="limit">一覧の表示件数</label>
    <input id="limit" type="number" value="50" min="1" max="500">
    <button id="reload">一覧取得</button>
    <label style="display:flex; gap:6px; align-items:center;">
      <input type="checkbox" id="showAllItems"> 非表示も含める
    </label>
    <button id="export">CSV出力</button>
  </div>
  
  <div class="row" style="margin-top:16px; margin-bottom:16px;">
    <label>分類を選択：</label>
    <select id="randCategory">
      <option value="バスケ">バスケ</option>
      <option value="生活">生活</option>
      <option value="仕事">仕事</option>
      <option value="勉強">勉強</option>
      <option value="その他">その他</option>
    </select>
    <label style="display:flex; gap:6px; align-items:center; margin-left:8px;">
      <input type="checkbox" id="randAll"> 全カテゴリから
    </label>
    <button id="showRandom">ランダム表示</button>
  </div>
  
  <div id="randomResult" class="item" style="display:none; background:#f7fff7;"></div>
    
  <div class="list" id="list"></div>

  <script>
    const API_BASE = "https://memo-save-api.jetkitayan.workers.dev";

    const form = document.getElementById("form");
    const text = document.getElementById("text");
    const category = document.getElementById("category");
    const msg = document.getElementById("msg");
    const list = document.getElementById("list");
    const limitInput = document.getElementById("limit");
    const reloadBtn = document.getElementById("reload");
    const logoutBtn = document.getElementById("logoutBtn");
    const authStatus = document.getElementById("authStatus");
    const exportBtn = document.getElementById("export");
    const showAllItems = document.getElementById("showAllItems");

    // ===== Basic認証まわり =====
    let authHeader = localStorage.getItem("memo_auth") || "";

    function setAuth(user, pass){
      authHeader = "Basic " + btoa(`${user}:${pass}`);
      localStorage.setItem("memo_auth", authHeader);
      authStatus.textContent = `ログイン中（Basic）`;
    }
    function clearAuth(){
      authHeader = "";
      localStorage.removeItem("memo_auth");
      authStatus.textContent = `未ログイン`;
    }
    async function ensureAuthInteractive() {
      if (authHeader) return true;
      const u = prompt("ユーザー名");
      if (u === null) return false;
      const p = prompt("パスワード");
      if (p === null) return false;
      setAuth(u, p);
      return true;
    }

    async function apiFetch(path, options = {}, retryOn401 = true) {
      const headers = {
        "Content-Type": "application/json",
        "Authorization": authHeader || "",
        ...(options.headers || {}),
      };
      const res = await fetch(`${API_BASE}${path}`, { ...options, headers });
      if (res.status === 401 && retryOn401) {
        clearAuth();
        const ok = await ensureAuthInteractive();
        if (!ok) return res;
        return apiFetch(path, options, false);
      }
      return res;
    }

    (function initAuth(){
      authStatus.textContent = authHeader ? `ログイン中（Basic）` : `未ログイン`;
    })();

    logoutBtn.addEventListener("click", () => {
      clearAuth();
      alert("ログアウトしました。操作時に再度認証を求めます。");
    });

    // ===== 保存 =====
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "";

      if (!authHeader) {
        const ok = await ensureAuthInteractive();
        if (!ok) { msg.textContent = "認証が必要です。"; return; }
      }

      const body = {
        text: text.value.trim(),
        category: category.value
      };
      if (!body.text) { msg.textContent = "文章が空です。"; return; }

      const res = await apiFetch(`/api/items`, {
        method: "POST",
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (res.ok && data.ok) {
        msg.textContent = "保存しました。";
        text.value = "";
        await loadList();
      } else {
        msg.textContent = (data && data.error) ? data.error : `保存に失敗（HTTP ${res.status})`;
      }
    });

    // ===== CSV出力 =====
    exportBtn.addEventListener("click", async () => {
      if (!authHeader) {
        const ok = await ensureAuthInteractive();
        if (!ok) { alert("認証が必要です"); return; }
      }
      const all = (showAllItems && showAllItems.checked) ? "?all=1" : "";
      const res = await apiFetch(`/api/export_csv${all}`);
      if (!res.ok) {
        alert(`エクスポート失敗（HTTP ${res.status}）`);
        return;
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `memo_items_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    const showRandomBtn = document.getElementById("showRandom");
    const randCategory  = document.getElementById("randCategory");
    const randAll       = document.getElementById("randAll");
    const randomResult  = document.getElementById("randomResult");
    
    // チェック時はカテゴリ選択を無効化（UI上の分かりやすさ）
    randAll.addEventListener("change", () => {
      randCategory.disabled = randAll.checked;
    });
    
    showRandomBtn.addEventListener("click", async () => {
      if (!authHeader) {
        const ok = await ensureAuthInteractive();
        if (!ok) return;
      }
      await doReroll();
    });

    // ===== 一覧 =====
    reloadBtn.addEventListener("click", loadList);

    async function loadList() {
      if (!authHeader) {
        const ok = await ensureAuthInteractive();
        if (!ok) { list.textContent = "認証が必要です。"; return; }
      }

      const limit = Number(limitInput.value || 50);
      const all = (showAllItems && showAllItems.checked) ? "&all=1" : "";
      const res = await apiFetch(`/api/items?limit=${encodeURIComponent(limit)}${all}`);
      const data = await res.json().catch(() => ({}));
      list.innerHTML = "";

      if (!res.ok || !data.ok) {
        list.textContent = (data && data.error) ? data.error : `取得に失敗（HTTP ${res.status})`;
        return;
      }
      if (!data.items || data.items.length === 0) {
        list.textContent = "登録はまだありません。";
        return;
      }

      for (const item of data.items) {
        const div = document.createElement("div");
        div.className = "item";
      
        const jstC = new Date(item.created_at).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
        const jstU = new Date(item.updated_at).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
        const visible = item.status === 1;
      
        const categories = ["バスケ","生活","仕事","勉強","その他"];
      
        div.innerHTML = `
          <div class="view">
            <div>${escapeHtml(item.text).replace(/\n/g, "<br>")}</div>
            <div class="meta">
              #${item.id} / 作成:${jstC} / 最終更新:${jstU} / [${escapeHtml(item.category || "その他")}]
              <button class="edit-btn" data-id="${item.id}" style="margin-left:8px;">編集</button>
              <button class="toggle-vis" data-id="${item.id}" style="margin-left:6px;">
                ${visible ? "非表示にする" : "表示にする"}
              </button>
              <button class="del-btn" data-id="${item.id}" style="margin-left:6px; border-color:#f33; color:#f33;">削除</button>
            </div>
          </div>
      
          <div class="edit">
            <textarea class="edit-text"></textarea>
            <div class="row">
              <label>分類：</label>
              <select class="edit-cat">
                ${categories.map(opt => `<option value="${opt}" ${opt===(item.category||"その他")?"selected":""}>${opt}</option>`).join("")}
              </select>
              <span class="right">
                <button class="save-btn" data-id="${item.id}">保存</button>
                <button class="cancel-btn">キャンセル</button>
              </span>
            </div>
          </div>
        `;
      
        // 初期値（生テキスト）
        div.querySelector(".edit-text").value = item.text;
  
        // 編集表示切替
        div.querySelector(".edit-btn").addEventListener("click", () => {
          div.querySelector(".view").style.display = "none";
          div.querySelector(".edit").style.display = "block";
        });
        div.querySelector(".cancel-btn").addEventListener("click", () => {
          div.querySelector(".edit").style.display = "none";
          div.querySelector(".view").style.display = "block";
        });
      
        // 保存（PUT /api/items/:id）
        div.querySelector(".save-btn").addEventListener("click", async (e) => {
          const id = Number(e.currentTarget.getAttribute("data-id"));
          const newText = div.querySelector(".edit-text").value;
          const newCat  = div.querySelector(".edit-cat").value;
      
          const r = await apiFetch(`/api/items/${id}`, {
            method: "PUT",
            body: JSON.stringify({ text: newText, category: newCat })
          });
          const d = await r.json().catch(()=> ({}));
          if (r.ok && d.ok) {
            await loadList();
          } else {
            alert("更新に失敗しました");
          }
        });
      
        // 表示/非表示 切替
        div.querySelector(".toggle-vis").addEventListener("click", async (e) => {
          const id = Number(e.currentTarget.getAttribute("data-id"));
          const nextVal = visible ? 0 : 1;
          const r = await apiFetch(`/api/items/${id}`, {
            method: "PUT",
            body: JSON.stringify({ status: nextVal })
          });
          const d = await r.json().catch(()=> ({}));
          if (r.ok && d.ok) { await loadList(); }
          else alert("表示状態の更新に失敗しました");
        });
      
        // 削除
        div.querySelector(".del-btn").addEventListener("click", async (e) => {
          const id = Number(e.currentTarget.getAttribute("data-id"));
          if (!confirm(`#${id} を削除しますか？`)) return;
          const delRes = await apiFetch(`/api/items/${id}`, { method: "DELETE" });
          const delData = await delRes.json().catch(() => ({}));
          if (delRes.ok && delData.ok) await loadList();
          else alert("削除に失敗しました。");
        });
      
        list.appendChild(div);
      }
    }

const randomResult  = document.getElementById("randomResult");
const randCategory  = document.getElementById("randCategory");
const randAll       = document.getElementById("randAll");
const showRandomBtn = document.getElementById("showRandom");

randAll.addEventListener("change", () => { randCategory.disabled = randAll.checked; });

function renderRandom(item){
  randomResult.style.display = "block";
  randomResult.dataset.id = item.id;

  const jstC = new Date(item.created_at).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
  const jstU = new Date(item.updated_at).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
  const visible = item.status === 1;
  const categories = ["バスケ","生活","仕事","勉強","その他"];
  const cat = item.category || "その他";

  randomResult.innerHTML = `
    <div class="view">
      <div>${escapeHtml(item.text).replace(/\n/g, "<br>")}</div>
      <div class="meta">
        #${item.id} / 作成:${jstC} / 最終更新:${jstU} / [${escapeHtml(cat)}]
        <button id="rndEdit" style="margin-left:8px;">編集</button>
        <button id="rndReroll" style="margin-left:6px;">もう一回</button>
        <button id="rndToggle" style="margin-left:6px;">
          ${visible ? "非表示にする" : "表示にする"}
        </button>
        <button id="rndDelete" style="margin-left:6px; border-color:#f33; color:#f33;">削除</button>
      </div>
    </div>
    <div class="edit" style="display:none;">
      <textarea id="rndText"></textarea>
      <div class="row">
        <label>分類：</label>
        <select id="rndCat">
          ${categories.map(opt => `<option value="${opt}" ${opt===cat?"selected":""}>${opt}</option>`).join("")}
        </select>
        <span class="right">
          <button id="rndSave">保存</button>
          <button id="rndCancel">キャンセル</button>
        </span>
      </div>
    </div>
  `;

  // フォーム初期値
  document.getElementById("rndText").value = item.text;

  // クリックハンドラ
  document.getElementById("rndEdit").addEventListener("click", () => {
    randomResult.querySelector(".view").style.display = "none";
    randomResult.querySelector(".edit").style.display = "block";
  });
  document.getElementById("rndCancel").addEventListener("click", () => {
    randomResult.querySelector(".edit").style.display = "none";
    randomResult.querySelector(".view").style.display = "block";
  });

  document.getElementById("rndSave").addEventListener("click", async () => {
    const id   = Number(randomResult.dataset.id);
    const text = document.getElementById("rndText").value;
    const cat  = document.getElementById("rndCat").value;

    const r = await apiFetch(`/api/items/${id}`, {
      method: "PUT",
      body: JSON.stringify({ text, category: cat })
    });
    const d = await r.json().catch(()=> ({}));
    if (r.ok && d.ok) {
      // 最新状態を1件取得して描画し直す
      const res2 = await apiFetch(`/api/items/${id}`);
      const data2 = await res2.json().catch(()=> ({}));
      if (res2.ok && data2.ok) renderRandom(data2.item);
      await loadList(); // 一覧も更新（updated_at反映）
    } else {
      alert("更新に失敗しました");
    }
  });

  document.getElementById("rndToggle").addEventListener("click", async () => {
    const id = Number(randomResult.dataset.id);
    const nextVal = visible ? 0 : 1;
    const r = await apiFetch(`/api/items/${id}`, {
      method: "PUT",
      body: JSON.stringify({ status: nextVal })
    });
    const d = await r.json().catch(()=> ({}));
    if (r.ok && d.ok) {
      // 反映後、同じ条件で再抽選（非表示にしたら見えなくなるので）
      await doReroll();
      await loadList();
    } else {
      alert("表示状態の更新に失敗しました");
    }
  });

  document.getElementById("rndDelete").addEventListener("click", async () => {
    const id = Number(randomResult.dataset.id);
    if (!confirm(`#${id} を削除しますか？`)) return;
    const r = await apiFetch(`/api/items/${id}`, { method: "DELETE" });
    const d = await r.json().catch(()=> ({}));
    if (r.ok && d.ok) {
      randomResult.style.display = "none";
      await loadList();
    } else {
      alert("削除に失敗しました");
    }
  });

  document.getElementById("rndReroll").addEventListener("click", doReroll);
}

async function doReroll(){
  // 直前のUI状態（全カテゴリ or 指定カテゴリ）に従って再抽選
  const useAll = randAll && randAll.checked;
  const cat = randCategory ? randCategory.value : "その他";
  const qs = useAll ? "" : `?category=${encodeURIComponent(cat)}`;

  const res = await apiFetch(`/api/items/random${qs}`);
  const data = await res.json().catch(()=> ({}));
  if (res.ok && data.ok) renderRandom(data.item);
  else {
    randomResult.style.display = "block";
    randomResult.textContent = data.error || `再取得に失敗（HTTP ${res.status})`;
  }
}
    
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // 初回ロード
    loadList();
  </script>
</body>
</html>
